<mat-card class="pay-card">

  <div class="header">
    <h2>Pay EMI</h2>
    <p>Secure loan repayment</p>
  </div>

  <form [formGroup]="form">

    <!-- LOAN ID -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Loan ID</mat-label>
      <input matInput type="number" formControlName="loanId" />
    </mat-form-field>

    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="fetchLoan()"
      [disabled]="loading() || form.get('loanId')?.invalid">
      Fetch Loan Details
    </button>

    <!-- MESSAGE -->
    <div
      *ngIf="message()"
      class="info-message"
      [ngClass]="{
        success: message()?.includes('successfully'),
        error: message()?.includes('failed') || message()?.includes('Invalid')
      }">
      {{ message() }}
    </div>

    <!-- PAYMENT OPTIONS -->
    <div *ngIf="!message() && (nextEmi || outstandingAmount > 0)" class="payment-section">

      <mat-radio-group
        class="payment-options"
        formControlName="paymentType">

        <mat-radio-button value="emi" [disabled]="!nextEmi">
          Pay Next EMI
        </mat-radio-button>

        <mat-radio-button value="full" [disabled]="outstandingAmount === 0">
          Pay Full Outstanding
        </mat-radio-button>

      </mat-radio-group>

      <!-- EMI DETAILS -->
      <div class="payment-box" *ngIf="form.value.paymentType === 'emi' && nextEmi">
        <p><strong>Installment No:</strong> {{ nextEmi.installmentNumber }}</p>
        <p><strong>Amount:</strong> ₹ {{ nextEmi.amount }}</p>
      </div>

      <!-- FULL PAYMENT -->
      <div class="payment-box" *ngIf="form.value.paymentType === 'full'">
        <p><strong>Total Outstanding</strong></p>
        <h3>₹ {{ outstandingAmount }}</h3>
      </div>

      <!-- ===== PAYMENT METHOD ===== -->
<div class="payment-method">

  <h4>Choose Payment Method</h4>

  <mat-radio-group
    formControlName="paymentMethod"
    class="method-options">

    <mat-radio-button value="upi">
      UPI
    </mat-radio-button>

    <mat-radio-button value="debit">
      Debit Card
    </mat-radio-button>

    <mat-radio-button value="credit">
      Credit Card
    </mat-radio-button>

  </mat-radio-group>

</div>

      <button
        mat-raised-button
        color="accent"
        type="button"
        (click)="pay()"
        [disabled]="loading()">
        Pay Now
      </button>

    </div>

  </form>

  <!-- ===== RECEIPT ===== -->
  <div *ngIf="receipt()" class="receipt-card">

    <h3>Payment Receipt</h3>

    <div class="receipt-row">
      <span>Loan ID</span>
      <strong>{{ receipt()?.loanId }}</strong>
    </div>

    <div class="receipt-row">
      <span>Payment Type</span>
      <strong>{{ receipt()?.paymentType }}</strong>
    </div>

    <div class="receipt-row">
      <span>EMI No</span>
      <strong>{{ receipt()?.emiNo }}</strong>
    </div>

    <div class="receipt-row">
      <span>Amount Paid</span>
      <strong>₹ {{ receipt()?.amount }}</strong>
    </div>

    <div class="receipt-row">
  <span>Payment Method</span>
  <strong>{{ receipt()?.paymentMethod | uppercase }}</strong>
</div>


    <div class="receipt-row">
      <span>Payment Date</span>
      <strong>{{ receipt()?.paymentDate | date:'medium' }}</strong>
    </div>

  </div>

</mat-card>
